#include <stdio.h>
#include <string.h>
#include <stdlib.h>

int check = 0;


struct Object {

    char stackData[32];
    void (*check_0)();
    void (*check_1)();

};


void secret(){
	
   
    if(check == 0){ 

      printf("You are in secret!\nTerminating...\n");
      exit(0);          
      
    }
    printf("\x1b[33mpwned :P\nHere's a shell:\x1b[30m\n");
    system("/bin/sh");
    exit(0);
}


void check_0(){


    printf("First check was done!\n");

}


void check_1(){


    printf("Second check was done!\n");


}


struct Object *_object;


void terminateObject(struct Object *obj){

    free(obj);

}

void create_data_obj(){


    char *objectData = malloc(200);
    char path[512];
    scanf("%s",path);

    FILE *file = fopen(path,"r");

    fread(objectData,1,64,file);

    printf("Data was created with \" %s \"\n",objectData);


}

void allocateObjectByUser(char inputForAlloc_[32]){

    printf("Enter some data to allocate!\n");
    scanf("%31s",inputForAlloc_);
    _object = malloc(200);
    strncpy(_object->stackData,inputForAlloc_,32);
    _object->check_0 = check_0;
    _object->check_1 = check_1;

    printf("Data was successfully allocated!\n");


}

void writeGadget(){

  __asm__("mov r6,r5");
  __asm__("str r0,[r1]");
  __asm__("pop {r7,pc}");


}


void gadget(){

  __asm__("pop {r0,r1,r2,pc}");


}

void pivot(){


__asm__("mov sp,r2");
__asm__(" pop {r7,pc}");
}

void gadget_1(){

__asm__("movt r0,#2");
__asm__("pop {r7,pc}");

}


int main(){

    printf("\x1b[33mWelcome to bsides_demo by @tomitokics!\x1b[30m\n[1] Allocate data\n[2] Open file\n[3] Allocate device\n[4] Free data\n[5] Call device methods\n[6] Exit\n\n");

  
    char inputForAlloc[32];
    


    int a;
    int while_loop = 1;

    while(while_loop == 1) {

        scanf("%d",&a);


        if(a == 1){


        allocateObjectByUser(inputForAlloc);



        }else if(a == 2){

            create_data_obj();

        }else if(a == 3){

        _object = malloc(256);
        _object->check_0 = check_0;
        _object->check_1 = check_1;

        printf("Device was allocated!\n");


        }else if(a == 4){


        if(_object){

            terminateObject(_object);
            printf("Data was freed!\n");
        }




        }else if(a == 5){
//        else if(!strcmp(input,"4")){


        printf("Testing methods...\n");
        if(_object){

        _object->check_0();
        _object->check_1();

        }


        }else if(a == 6){
//        else if(!strcmp(input,"5")){


        printf("Program exited normally!\n");
        exit(0);

    }else {

        printf("Invalid option!\n");

    }

}


    return 0;
}
